"use strict";(()=>{var e={};e.id=712,e.ids=[712],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},3837:e=>{e.exports=require("util")},9962:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{POST:()=>m});var n=r(9303),i=r(8716),a=r(670),o=r(7070),u=r(1247),d=r(3474),c=r(5630),p=r(9489);let l=c.Ry({bookingType:c.Km(["class","event"]),itemId:c.Z_().min(1,"Item ID is required"),userId:c.Z_().min(1,"User ID is required"),customAmount:c.Rx().optional(),discountAmount:c.Rx().default(0),taxAmount:c.Rx().default(0),successUrl:c.Z_().url("Valid success URL required"),cancelUrl:c.Z_().url("Valid cancel URL required")});async function m(e){try{let t,r,s;let n=(0,u.oV)();if(!n.isValid)return o.NextResponse.json({error:"Stripe configuration invalid",details:n.errors},{status:500});let i=await e.json(),{bookingType:a,itemId:c,userId:p,customAmount:m,discountAmount:_,taxAmount:h,successUrl:x,cancelUrl:f}=l.parse(i),g=null;if("class"===a){if(!(t=await d.Z.class.findUnique({where:{id:c},include:{venue:!0,classInstructors:{include:{instructor:{include:{user:!0}}}}}}))||!t.isActive)return o.NextResponse.json({error:"Class not found or inactive"},{status:404});r=Number(t.price),s=t.title,g=t.imageUrl}else{if(!(t=await d.Z.event.findUnique({where:{id:c},include:{venue:!0,organizer:!0}}))||"PUBLISHED"!==t.status)return o.NextResponse.json({error:"Event not found or not published"},{status:404});r=Number(t.price),s=t.title,g=t.imageUrl}let v=m||r,y=_||0,E=h||0,I=v-y+E;if(I<=0)return o.NextResponse.json({error:"Total amount must be greater than 0"},{status:400});let R=await d.Z.user.findUnique({where:{id:p}});if(!R)return o.NextResponse.json({error:"User not found"},{status:404});let q=await d.Z.booking.create({data:{userId:p,classId:"class"===a?c:null,eventId:"event"===a?c:null,status:"PENDING",totalAmount:v,amountPaid:0,discountAmount:y,taxAmount:E,paymentStatus:"pending",confirmationCode:`${a.toUpperCase()}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}),A=[{price_data:{currency:"usd",product_data:{name:s,description:`${"class"===a?"Dance Class":"Dance Event"} - ${t.description?.substring(0,100)}`,images:g?[g]:void 0,metadata:{bookingType:a,itemId:c,venue:t.venue?.name||"TBD"}},unit_amount:(0,u.bZ)(v)},quantity:1}];y>0&&A.push({price_data:{currency:"usd",product_data:{name:"Discount",description:"Applied discount"},unit_amount:-(0,u.bZ)(y)},quantity:1}),E>0&&A.push({price_data:{currency:"usd",product_data:{name:"Tax",description:"Applied tax"},unit_amount:(0,u.bZ)(E)},quantity:1});let S=await u.Ag.checkout.sessions.create({mode:"payment",payment_method_types:["card"],line_items:A,success_url:`${x}?session_id={CHECKOUT_SESSION_ID}`,cancel_url:f,customer_email:R.email,client_reference_id:q.id,metadata:{bookingId:q.id,userId:R.id,itemId:c,bookingType:a,itemName:s,userEmail:R.email,userName:R.fullName},payment_intent_data:{description:`${"class"===a?"Class":"Event"} Booking: ${s}`,metadata:{bookingId:q.id,userId:R.id,itemId:c,bookingType:a,itemName:s},receipt_email:R.email},expires_at:Math.floor(Date.now()/1e3)+1800});return await d.Z.booking.update({where:{id:q.id},data:{stripeSessionId:S.id}}),await d.Z.transaction.create({data:{bookingId:q.id,userId:R.id,provider:"STRIPE",stripeSessionId:S.id,type:"PAYMENT",status:"CREATED",amount:I,currency:"USD",payload:JSON.stringify(S)}}),o.NextResponse.json({success:!0,sessionId:S.id,sessionUrl:S.url,booking:{id:q.id,confirmationCode:q.confirmationCode,totalAmount:v,discountAmount:y,taxAmount:E,finalAmount:I}})}catch(e){if(console.error("Create checkout session error:",e),e instanceof p.j)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return o.NextResponse.json({error:"Failed to create checkout session",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let _=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payments/create-checkout-session/route",pathname:"/api/payments/create-checkout-session",filename:"route",bundlePath:"app/api/payments/create-checkout-session/route"},resolvedPagePath:"/Users/hemantd/DL/dance-platform/app/api/payments/create-checkout-session/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:f}=_,g="/api/payments/create-checkout-session/route";function v(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:x})}},3474:(e,t,r)=>{r.d(t,{Z:()=>n});var s=r(3524);let n=global.prisma||new s.PrismaClient},1247:(e,t,r)=>{r.d(t,{Ag:()=>n,bZ:()=>i,oV:()=>a});var s=r(1059);r(468);let n=new s.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20",typescript:!0}),i=(e,t="usd")=>Math.round(100*e),a=()=>{let e=[];return process.env.STRIPE_SECRET_KEY||e.push("STRIPE_SECRET_KEY is not set"),{isValid:0===e.length,errors:e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,50,630],()=>r(9962));module.exports=s})();