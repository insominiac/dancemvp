"use strict";(()=>{var e={};e.id=800,e.ids=[800],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},3837:e=>{e.exports=require("util")},2671:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>E,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>v,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{POST:()=>m});var s=r(9303),a=r(8716),i=r(670),o=r(7070),u=r(1247),p=r(3474),d=r(5630),l=r(9489);let c=d.Ry({bookingType:d.Km(["class","event"]),itemId:d.Z_().min(1,"Item ID is required"),userId:d.Z_().min(1,"User ID is required"),customAmount:d.Rx().optional(),discountAmount:d.Rx().default(0),taxAmount:d.Rx().default(0),customerEmail:d.Z_().email().optional(),customerName:d.Z_().optional()});async function m(e){try{let t,r,n;let s=(0,u.oV)();if(!s.isValid)return o.NextResponse.json({error:"Stripe configuration invalid",details:s.errors},{status:500});let a=await e.json(),{bookingType:i,itemId:d,userId:l,customAmount:m,discountAmount:f,taxAmount:y,customerEmail:x,customerName:v}=c.parse(a);if("class"===i){if(!(t=await p.Z.class.findUnique({where:{id:d},include:{venue:!0,classInstructors:{include:{instructor:{include:{user:!0}}}}}}))||!t.isActive)return o.NextResponse.json({error:"Class not found or inactive"},{status:404});r=Number(t.price),n=t.title}else{if(!(t=await p.Z.event.findUnique({where:{id:d},include:{venue:!0,organizer:!0}}))||"PUBLISHED"!==t.status)return o.NextResponse.json({error:"Event not found or not published"},{status:404});r=Number(t.price),n=t.title}let g=m||r,E=f||0,h=y||0,R=g-E+h;if(R<=0)return o.NextResponse.json({error:"Total amount must be greater than 0"},{status:400});let I=await p.Z.user.findUnique({where:{id:l}});if(!I)return o.NextResponse.json({error:"User not found"},{status:404});let A=await p.Z.booking.create({data:{userId:l,classId:"class"===i?d:null,eventId:"event"===i?d:null,status:"PENDING",totalAmount:g,amountPaid:0,discountAmount:E,taxAmount:h,paymentStatus:"pending",confirmationCode:`${i.toUpperCase()}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}),_=await u.Ag.paymentIntents.create({amount:(0,u.bZ)(R),currency:"usd",payment_method_types:["card"],metadata:{bookingId:A.id,userId:I.id,itemId:d,bookingType:i,itemName:n,userEmail:I.email,userName:I.fullName},description:`${"class"===i?"Class":"Event"} Booking: ${n}`,receipt_email:x||I.email,setup_future_usage:"off_session"});return await p.Z.transaction.create({data:{bookingId:A.id,userId:I.id,provider:"STRIPE",providerPaymentId:_.id,type:"PAYMENT",status:"CREATED",amount:R,currency:"USD",payload:JSON.stringify(_)}}),o.NextResponse.json({success:!0,paymentIntent:{id:_.id,clientSecret:_.client_secret,amount:R,currency:"usd"},booking:{id:A.id,confirmationCode:A.confirmationCode,totalAmount:g,discountAmount:E,taxAmount:h,finalAmount:R}})}catch(e){if(console.error("Create payment intent error:",e),e instanceof l.j)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return o.NextResponse.json({error:"Failed to create payment intent",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payments/create-payment-intent/route",pathname:"/api/payments/create-payment-intent",filename:"route",bundlePath:"app/api/payments/create-payment-intent/route"},resolvedPagePath:"/Users/hemantd/DL/dance-platform/app/api/payments/create-payment-intent/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:v}=f,g="/api/payments/create-payment-intent/route";function E(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:x})}},3474:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(3524);let s=global.prisma||new n.PrismaClient},1247:(e,t,r)=>{r.d(t,{Ag:()=>s,bZ:()=>a,oV:()=>i});var n=r(1059);r(468);let s=new n.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20",typescript:!0}),a=(e,t="usd")=>Math.round(100*e),i=()=>{let e=[];return process.env.STRIPE_SECRET_KEY||e.push("STRIPE_SECRET_KEY is not set"),{isValid:0===e.length,errors:e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,972,50,630],()=>r(2671));module.exports=n})();